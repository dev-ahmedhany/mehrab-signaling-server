version: '3.8'

services:
  signaling-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mehrab-signaling
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - TURN_SECRET=${TURN_SECRET}
      - TURN_DOMAIN=${TURN_DOMAIN:-turn.ahmedhany.dev}
      - TURN_CREDENTIAL_TTL=${TURN_CREDENTIAL_TTL:-3600}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
    networks:
      - mehrab-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  coturn:
    image: coturn/coturn:4.6
    container_name: mehrab-coturn
    restart: unless-stopped
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "5349:5349/udp"
      - "5349:5349/tcp"
      - "49152-65535:49152-65535/udp"
    volumes:
      - ./turnserver.conf:/etc/coturn/turnserver.conf:ro
      - ./certs:/etc/coturn/certs:ro
    environment:
      - TURN_SECRET=${TURN_SECRET}
    networks:
      - mehrab-network
    command: ["-c", "/etc/coturn/turnserver.conf"]

networks:
  mehrab-network:
    driver: bridge
